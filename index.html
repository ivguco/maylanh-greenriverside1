    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBKlUVKYO0PoafJX44dgg20qkISJB7SaYk",
            authDomain: "maylanh-abc69.firebaseapp.com",
            databaseURL: "https://maylanh-abc69-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "maylanh-abc69",
            storageBucket: "maylanh-abc69.appspot.com",
            messagingSenderId: "312034622813",
            appId: "1:312034622813:web:b30608f628c7c7bd963cb4"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const historyRef = database.ref('history');
        
        // Test connection
        console.log('Firebase initialized:', firebaseConfig);
        
        // Add connection status indicator
        const connectedRef = database.ref(".info/connected");
        connectedRef.on("value", (snap) => {
            if (snap.val() === true) {
                console.log("Connected to Firebase!");
                showStatus("Đã kết nối với cơ sở dữ liệu", "success");
            } else {
                console.log("Not connected to Firebase");
                showStatus("Đang kết nối...", "warning");
            }
        });
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status') || createStatusDiv();
            statusDiv.textContent = message;
            statusDiv.className = `status-${type}`;
        }
        
        function createStatusDiv() {
            const div = document.createElement('div');
            div.id = 'status';
            div.style.cssText = 'position:fixed;top:10px;right:10px;padding:10px;border-radius:5px;color:white;font-weight:bold;z-index:1000;';
            document.body.appendChild(div);
            return div;
        }

        // --- CORE FUNCTIONS ---
        function saveNewRecord() {
            const room = document.getElementById('room-1').value;
            const date = document.getElementById('update-1').value;
            const price = document.getElementById('price-1').value;
            const status = document.getElementById('status-1').value;

            if (date && price && status) {
                console.log('Saving record:', { room, date, price, status });
                historyRef.push({ room, date, price, status })
                    .then(() => {
                        console.log('Record saved successfully');
                        showStatus("Đã lưu thành công!", "success");
                        document.getElementById('last-1').innerText = date;
                    })
                    .catch((error) => {
                        console.error('Error saving record:', error);
                        showStatus("Lỗi khi lưu: " + error.message, "error");
                    });
            } else {
                alert('Vui lòng điền đầy đủ thông tin.');
            }
        }

        function deleteHistoryRow(recordId) {
            if (confirm('Bạn có chắc chắn muốn xoá bản ghi này vĩnh viễn?')) {
                console.log('Deleting record:', recordId);
                database.ref('history/' + recordId).remove()
                    .then(() => {
                        console.log('Record deleted successfully');
                        showStatus("Đã xoá thành công!", "success");
                    })
                    .catch((error) => {
                        console.error('Error deleting record:', error);
                        showStatus("Lỗi khi xoá: " + error.message, "error");
                    });
            }
        }

        function resetAllHistory() {
            if (confirm('!!! CẢNH BÁO !!!\nBạn có chắc muốn XOÁ TOÀN BỘ LỊCH SỬ của tất cả mọi người không? Hành động này không thể hoàn tác.')) {
                console.log('Resetting all history');
                historyRef.remove()
                    .then(() => {
                        console.log('All history reset successfully');
                        showStatus("Đã xoá toàn bộ lịch sử!", "success");
                    })
                    .catch((error) => {
                        console.error('Error resetting history:', error);
                        showStatus("Lỗi khi reset: " + error.message, "error");
                    });
            }
        }

        // --- REAL-TIME DATA LISTENER ---
        historyRef.on('value', (snapshot) => {
            console.log('Data received from Firebase:', snapshot.val());
            const historyData = snapshot.val();
            const historyBody = document.getElementById('historyBody');
            const monthHistoryContainer = document.getElementById('monthHistory');
            
            historyBody.innerHTML = '';
            monthHistoryContainer.innerHTML = '';

            const monthData = {};

            if (historyData) {
                Object.keys(historyData).forEach(key => {
                    const record = historyData[key];
                    const { room, date, price, status } = record;

                    // Populate history table
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${room}</td><td>${date}</td><td>${price}</td><td>${status}</td><td><button onclick="deleteHistoryRow('${key}')" style='background:#e53e3e;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;'>Xoá</button></td>`;
                    historyBody.appendChild(tr);

                    // Group data by month
                    const month = date.substring(0, 7); // "YYYY-MM"
                    if (!monthData[month]) {
                        monthData[month] = [];
                    }
                    monthData[month].push(record);
                });
            }
            
            // Populate month boxes
            const sortedMonths = Object.keys(monthData).sort().reverse();
            sortedMonths.forEach(monthKey => {
                const monthName = new Date(monthKey + '-02').toLocaleString('vi-VN', { month: 'long', year: 'numeric' });
                const monthBox = document.createElement('div');
                monthBox.className = 'month-box';
                let listItems = '';
                monthData[monthKey].forEach(rec => {
                    listItems += `<li>${rec.room} | ${rec.date} | ${rec.price}đ | ${rec.status}</li>`;
                });
                monthBox.innerHTML = `<h3>${monthName}</h3><ul class="month-list">${listItems}</ul>`;
                monthHistoryContainer.appendChild(monthBox);
            });
        }, (error) => {
            console.error('Error reading data:', error);
            showStatus("Lỗi khi đọc dữ liệu: " + error.message, "error");
        });

        // --- UTILITY FUNCTIONS ---
        function exportToExcel() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "Phòng,Ngày sửa,Giá sửa (VNĐ),Tình trạng\n";
            const rows = document.querySelectorAll('#historyBody tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length >= 4) {
                    csvContent += `${cols[0].innerText},${cols[1].innerText},${cols[2].innerText},"${cols[3].innerText}"\n`;
                }
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "lich_su_sua_chua.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
    <style>
        .month-list li:last-child { margin-bottom: 0; }
        
        /* Status notifications */
        .status-success {
            background-color: #38a169 !important;
        }
        .status-warning {
            background-color: #d69e2e !important;
        }
        .status-error {
            background-color: #e53e3e !important;
        }
    </style> 