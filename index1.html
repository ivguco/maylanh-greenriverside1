    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ====================================================================================
        // === PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE ===
        // ====================================================================================
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_PROJECT_ID.appspot.com",
          messagingSenderId: "YOUR_SENDER_ID",
          appId: "YOUR_APP_ID"
        };
        // ====================================================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const historyCollection = collection(db, "repairs");

        // --- MAIN FUNCTIONS ---

        async function updateRow(id) {
            const room = document.getElementById('room-' + id).value;
            const date = document.getElementById('update-' + id).value;
            const price = document.getElementById('price-' + id).value;
            const status = document.getElementById('status-' + id).value;

            if (date && price && status) {
                try {
                    await addDoc(historyCollection, {
                        room: room,
                        date: date,
                        price: price,
                        status: status,
                        createdAt: new Date()
                    });
                    alert(`Đã lưu phòng ${room} lên hệ thống.`);
                } catch (e) {
                    console.error("Error adding document: ", e);
                    alert("Có lỗi xảy ra, không thể lưu lên hệ thống. Vui lòng kiểm tra lại cấu hình Firebase.");
                }
            } else {
                alert('Vui lòng điền đầy đủ thông tin.');
            }
        }

        async function deleteHistoryItem(id) {
            await deleteDoc(doc(db, "repairs", id));
        }

        async function resetAllHistory() {
            if (confirm('BẠN CÓ CHẮC MUỐN XOÁ TOÀN BỘ LỊCH SỬ? HÀNH ĐỘNG NÀY KHÔNG THỂ HOÀN TÁC!')) {
                const querySnapshot = await getDocs(historyCollection);
                querySnapshot.forEach((doc) => {
                    deleteDoc(doc.ref);
                });
            }
        }

        function exportToExcel() {
            let csv = 'Phòng,Ngày sửa,Giá sửa (VNĐ),Tình trạng\n';
            const rows = document.querySelectorAll('#historyBody tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length >= 4) {
                    csv += `${cols[0].innerText},${cols[1].innerText},${cols[2].innerText},${cols[3].innerText}\n`;
                }
            });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lich_su_sua_chua.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // --- UI RENDERING ---

        function renderHistory(docs) {
            const historyBody = document.getElementById('historyBody');
            const monthLists = document.querySelectorAll('.month-list');
            
            historyBody.innerHTML = '';
            monthLists.forEach(list => list.innerHTML = '');

            docs.forEach((doc) => {
                const item = doc.data();
                const id = doc.id;

                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.room}</td><td>${item.date}</td><td>${item.price}</td><td>${item.status}</td><td><button data-id="${id}" class="delete-btn" style='background:#e53e3e;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;'>Xoá</button></td>`;
                historyBody.appendChild(tr);

                const month = item.date.split('-')[1];
                const monthBox = document.querySelector(`.month-box[data-month="${month}"] .month-list`);
                if(monthBox) {
                    const li = document.createElement('li');
                    li.textContent = `${item.room} | ${item.date} | ${item.price}đ | ${status}`;
                    monthBox.appendChild(li);
                }
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', () => {
                    if (confirm('Bạn có chắc muốn xoá mục này?')) {
                        deleteHistoryItem(button.dataset.id);
                    }
                });
            });
        }
        
        // --- REAL-TIME LISTENER ---
        const q = query(historyCollection, orderBy("createdAt", "desc"));
        onSnapshot(q, (querySnapshot) => {
            renderHistory(querySnapshot.docs);
        }, (error) => {
            console.error("Firebase Error: ", error);
            if(firebaseConfig.apiKey === "YOUR_API_KEY") {
                alert("LỖI: Cấu hình Firebase chưa được thiết lập. Vui lòng làm theo hướng dẫn để lấy và dán cấu hình vào file index.html.");
            } else {
                alert("Không thể kết nối tới Firebase. Vui lòng kiểm tra console (F12) để xem chi tiết lỗi.");
            }
        });
        
        // Make functions globally available for inline onclick attributes
        window.updateRow = updateRow;
        window.resetAllHistory = resetAllHistory;
        window.exportToExcel = exportToExcel;
    </script>
</body> 